<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>BracketGPT</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=IBM+Plex+Mono:wght@500;600&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #f6f8fc;
      --bg-soft: #eef2f9;
      --surface: #ffffff;
      --surface-2: #f9fbff;
      --text: #101828;
      --text-muted: #667085;
      --primary: #2563eb;
      --primary-soft: rgba(37, 99, 235, 0.12);
      --success: #12b76a;
      --border: #dbe3f0;
      --border-strong: #c8d3e6;
      --radius-sm: 10px;
      --radius-md: 14px;
      --radius-lg: 18px;
      --shadow-sm: 0 1px 3px rgba(16, 24, 40, 0.06);
      --shadow-md: 0 12px 28px rgba(16, 24, 40, 0.08);
      --font-body: 'Manrope', sans-serif;
      --font-mono: 'IBM Plex Mono', monospace;
      --transition: 0.18s ease;
    }

    html, body { height: 100%; }

    body {
      font-family: var(--font-body);
      color: var(--text);
      background:
        radial-gradient(circle at 2% 0%, rgba(37, 99, 235, 0.06), transparent 28%),
        radial-gradient(circle at 100% 15%, rgba(18, 183, 106, 0.05), transparent 35%),
        var(--bg);
      -webkit-font-smoothing: antialiased;
      overflow: hidden;
    }

    .app {
      height: 100%;
      max-width: 1120px;
      margin: 0 auto;
      padding: 14px;
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 12px;
    }

    .hdr {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      background: rgba(255, 255, 255, 0.88);
      backdrop-filter: blur(8px);
      box-shadow: var(--shadow-sm);
    }

    .logo {
      width: 34px;
      height: 34px;
      border-radius: 9px;
      display: grid;
      place-items: center;
      color: #fff;
      font-weight: 800;
      font-family: var(--font-mono);
      font-size: 13px;
      background: linear-gradient(140deg, #1d4ed8, #2563eb);
    }

    .title-wrap h1 {
      font-size: 15px;
      line-height: 1;
      font-weight: 800;
      letter-spacing: 0.01em;
    }

    .sub {
      margin-top: 4px;
      font-size: 11px;
      color: var(--text-muted);
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .live {
      margin-left: auto;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      letter-spacing: 0.03em;
      color: #03543f;
      background: #ecfdf3;
      border: 1px solid #abefc6;
      border-radius: 999px;
      padding: 6px 10px;
      white-space: nowrap;
    }

    .live::before {
      content: '';
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--success);
    }

    .msgs {
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      background: var(--surface);
      box-shadow: var(--shadow-md);
      overflow-y: auto;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 0;
    }

    .hero {
      min-height: 100%;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      background: linear-gradient(180deg, #ffffff, #f8fbff);
      display: grid;
      place-items: center;
      padding: 34px 22px;
      text-align: center;
    }

    .kicker {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--surface-2);
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .hero h2 {
      margin-top: 14px;
      font-size: clamp(30px, 5vw, 44px);
      line-height: 1.06;
      letter-spacing: -0.02em;
    }

    .tagline {
      margin-top: 8px;
      font-size: clamp(16px, 2vw, 20px);
      color: #344054;
      font-weight: 700;
    }

    .hero p {
      margin: 12px auto 22px;
      max-width: 620px;
      color: var(--text-muted);
      line-height: 1.6;
      font-size: 14px;
    }

    .cta {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 14px;
    }

    .cta-btn {
      border: 1px solid var(--border-strong);
      border-radius: var(--radius-sm);
      background: var(--surface);
      color: var(--text);
      font-family: var(--font-body);
      font-size: 13px;
      font-weight: 700;
      padding: 10px 14px;
      cursor: pointer;
      transition: border-color var(--transition), transform var(--transition), box-shadow var(--transition);
    }

    .cta-btn.primary {
      border-color: #1d4ed8;
      background: linear-gradient(140deg, #1d4ed8, #2563eb);
      color: #fff;
    }

    .cta-btn:hover {
      border-color: #98a2b3;
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(16, 24, 40, 0.08);
    }

    .cta-btn.primary:hover {
      border-color: #1e40af;
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.28);
    }

    .quick {
      max-width: 760px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
    }

    .quick button {
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: #fff;
      color: #344054;
      font-size: 12px;
      font-weight: 600;
      padding: 10px;
      cursor: pointer;
      text-align: left;
      transition: all var(--transition);
    }

    .quick button:hover {
      background: var(--surface-2);
      border-color: #bfd1f8;
      color: #1d4ed8;
    }

    .hypo {
      margin-top: 14px;
      display: grid;
      grid-template-columns: 1fr auto 1fr auto;
      gap: 8px;
      align-items: center;
      max-width: 760px;
      margin-left: auto;
      margin-right: auto;
    }

    .hypo input {
      min-width: 0;
      height: 40px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 0 12px;
      background: #fff;
      color: var(--text);
      outline: none;
    }

    .hypo input:focus { border-color: #87a8f9; box-shadow: 0 0 0 3px var(--primary-soft); }
    .hypo .vs-text { font-size: 11px; color: var(--text-muted); font-family: var(--font-mono); }

    .m {
      max-width: 86%;
      display: flex;
      gap: 8px;
      animation: rise .18s ease;
    }

    .m.u {
      margin-left: auto;
      flex-direction: row-reverse;
    }

    .av {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      display: grid;
      place-items: center;
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 700;
      flex-shrink: 0;
      margin-top: 3px;
    }

    .m.b .av { background: #eaf1ff; color: #1d4ed8; border: 1px solid #bfd1f8; }
    .m.u .av { background: #f2f4f7; color: #344054; border: 1px solid #d0d5dd; }

    .bd {
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fff;
      padding: 10px 12px;
      font-size: 14px;
      line-height: 1.55;
      color: var(--text);
    }

    .m.u .bd {
      background: #f8faff;
      border-color: #c4d6ff;
    }

    .scoreboard {
      margin: 8px 0 10px;
      border: 1px solid #d0ddff;
      border-radius: 12px;
      background: #f8faff;
      overflow: hidden;
    }

    .teams { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; }
    .team { padding: 10px; text-align: center; }
    .team .name { font-size: 11px; font-weight: 700; letter-spacing: .04em; text-transform: uppercase; color: #475467; }
    .team .score { margin-top: 4px; font-size: 34px; line-height: 1; font-weight: 800; color: #101828; }
    .winner .score, .winner .name { color: #1d4ed8; }
    .vs { font-family: var(--font-mono); font-size: 11px; color: var(--text-muted); padding: 0 6px; }

    .metrics { border-top: 1px solid #d0ddff; padding: 10px; }
    .bar-head { display: flex; justify-content: space-between; font-size: 11px; color: #475467; text-transform: uppercase; letter-spacing: .05em; }
    .bar-track { margin-top: 6px; height: 8px; border-radius: 999px; background: #e4e7ec; overflow: hidden; }
    .bar-fill { width: 0; height: 100%; border-radius: inherit; background: linear-gradient(90deg, #1d4ed8, #2e90fa); transition: width .8s ease; }

    .upset {
      margin-top: 8px;
      display: inline-block;
      font-size: 10px;
      font-family: var(--font-mono);
      color: #b42318;
      background: #fef3f2;
      border: 1px solid #fecdca;
      border-radius: 999px;
      padding: 4px 8px;
      text-transform: uppercase;
      letter-spacing: .04em;
    }

    .typing { display: none; }
    .typing.on { display: flex; }
    .dots {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fff;
      padding: 12px 10px;
      display: flex;
      gap: 5px;
      align-items: center;
    }

    .dots span {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #98a2b3;
      animation: blink 1.2s infinite both;
    }

    .dots span:nth-child(2) { animation-delay: .2s; }
    .dots span:nth-child(3) { animation-delay: .4s; }

    .iw {
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      background: var(--surface);
      box-shadow: var(--shadow-sm);
      padding: 10px;
    }

    .ir {
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 6px 6px 6px 12px;
      background: #fff;
    }

    .ir:focus-within {
      border-color: #87a8f9;
      box-shadow: 0 0 0 3px var(--primary-soft);
    }

    .ir input {
      border: none;
      outline: none;
      background: transparent;
      flex: 1;
      min-width: 0;
      font-size: 14px;
      color: var(--text);
    }

    .ir input::placeholder { color: #98a2b3; }

    .snd {
      width: 36px;
      height: 36px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(140deg, #1d4ed8, #2563eb);
      color: #fff;
      display: grid;
      place-items: center;
      cursor: pointer;
      transition: transform var(--transition), box-shadow var(--transition);
    }

    .snd:hover { transform: translateY(-1px); box-shadow: 0 8px 18px rgba(37, 99, 235, 0.32); }
    .hint { text-align: center; margin-top: 7px; font-size: 11px; color: var(--text-muted); }

    .onboarding-overlay {
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(16, 24, 40, 0.58);
      backdrop-filter: blur(8px);
      animation: ob-fade .22s ease;
    }

    .onboarding-overlay.hidden { display: none; }

    .onboarding-card {
      width: min(520px, 92vw);
      border: 1px solid var(--border);
      border-radius: 20px;
      background: #fff;
      box-shadow: 0 18px 40px rgba(16, 24, 40, 0.18);
      padding: 24px;
    }

    .onboarding-header { text-align: center; margin-bottom: 18px; }
    .ob-logo {
      width: 44px;
      height: 44px;
      margin: 0 auto 12px;
      border-radius: 12px;
      background: linear-gradient(140deg, #1d4ed8, #2563eb);
      color: #fff;
      font-family: var(--font-mono);
      font-size: 13px;
      font-weight: 700;
      display: grid;
      place-items: center;
    }
    .onboarding-header h2 { font-size: 22px; letter-spacing: -0.02em; }
    .onboarding-header p { color: var(--text-muted); margin-top: 6px; font-size: 14px; }

    .ob-step { display: none; }
    .ob-step.active { display: block; animation: ob-slide .2s ease; }
    .ob-question { font-size: 16px; font-weight: 700; }
    .ob-hint { margin-top: 4px; margin-bottom: 12px; color: var(--text-muted); font-size: 13px; }

    .ob-options { display: grid; gap: 8px; }
    .ob-option {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fff;
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 10px;
      align-items: center;
      text-align: left;
      padding: 11px 12px;
      cursor: pointer;
      transition: border-color var(--transition), background var(--transition), transform var(--transition);
      color: var(--text);
      font-family: var(--font-body);
    }
    .ob-option:hover { border-color: #87a8f9; background: #f8faff; transform: translateX(2px); }
    .ob-option.selected {
      border-color: #1d4ed8;
      background: linear-gradient(180deg, #ffffff, #f5f9ff);
      box-shadow: 0 0 0 3px var(--primary-soft);
    }

    .ob-emoji {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      background: #eef4ff;
      color: #1d4ed8;
      border: 1px solid #d8e5ff;
      display: grid;
      place-items: center;
      font-size: 11px;
      font-family: var(--font-mono);
      font-weight: 600;
      text-transform: uppercase;
    }
    .ob-label { font-size: 14px; font-weight: 700; }
    .ob-desc { font-size: 12px; color: var(--text-muted); white-space: nowrap; }

    .ob-nav {
      margin-top: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .ob-dots { display: flex; gap: 6px; }
    .ob-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #d0d5dd;
      transition: background var(--transition);
    }
    .ob-dot.active { background: #1d4ed8; }
    .ob-skip {
      border: none;
      background: none;
      color: var(--text-muted);
      font-size: 13px;
      cursor: pointer;
      font-family: var(--font-body);
    }
    .ob-skip:hover { color: #344054; }

    code {
      font-family: var(--font-mono);
      background: #f2f4f7;
      border: 1px solid #e4e7ec;
      border-radius: 5px;
      padding: 1px 5px;
      font-size: 12px;
    }

    @keyframes rise { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes blink { 0%, 80%, 100% { opacity: .35; } 40% { opacity: 1; } }
    @keyframes ob-fade { from { opacity: 0; } to { opacity: 1; } }
    @keyframes ob-slide { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

    @media (max-width: 900px) {
      .quick { grid-template-columns: 1fr 1fr; }
    }

    @media (max-width: 700px) {
      .app { padding: 10px; gap: 10px; }
      .hdr { padding: 10px 12px; }
      .sub { display: none; }
      .msgs { padding: 10px; }
      .hero { padding: 24px 14px; }
      .hero p { margin-bottom: 16px; }
      .quick { grid-template-columns: 1fr; }
      .hypo { grid-template-columns: 1fr 1fr; }
      .hypo .vs-text { display: none; }
      .hypo .cta-btn { grid-column: span 2; }
      .m { max-width: 94%; }
      .team .score { font-size: 30px; }
      .onboarding-card { padding: 18px; }
      .ob-option { grid-template-columns: auto 1fr; }
      .ob-desc { grid-column: 2; white-space: normal; margin-top: -2px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="onboarding-overlay" id="onboarding">
      <div class="onboarding-card">
        <div class="onboarding-header">
          <div class="ob-logo">BG</div>
          <h2>Welcome to BracketGPT</h2>
          <p>Answer 3 quick questions so recommendations match your pool.</p>
        </div>

        <div class="ob-step active" data-step="1">
          <div class="ob-question">How big is your bracket pool?</div>
          <div class="ob-hint">This sets how contrarian your picks should be.</div>
          <div class="ob-options">
            <button class="ob-option" type="button" data-key="poolSize" data-value="small" onclick="selectOption(this)">
              <span class="ob-emoji">S</span>
              <span class="ob-label">Small</span>
              <span class="ob-desc">Under 25 people</span>
            </button>
            <button class="ob-option" type="button" data-key="poolSize" data-value="medium" onclick="selectOption(this)">
              <span class="ob-emoji">M</span>
              <span class="ob-label">Medium</span>
              <span class="ob-desc">25-100 people</span>
            </button>
            <button class="ob-option" type="button" data-key="poolSize" data-value="large" onclick="selectOption(this)">
              <span class="ob-emoji">L</span>
              <span class="ob-label">Large</span>
              <span class="ob-desc">100+ people</span>
            </button>
          </div>
        </div>

        <div class="ob-step" data-step="2">
          <div class="ob-question">What is your bracket style?</div>
          <div class="ob-hint">No wrong answer. This calibrates risk level.</div>
          <div class="ob-options">
            <button class="ob-option" type="button" data-key="style" data-value="chalk" onclick="selectOption(this)">
              <span class="ob-emoji">S</span>
              <span class="ob-label">Play it safe</span>
              <span class="ob-desc">Mostly favorites</span>
            </button>
            <button class="ob-option" type="button" data-key="style" data-value="balanced" onclick="selectOption(this)">
              <span class="ob-emoji">B</span>
              <span class="ob-label">Balanced</span>
              <span class="ob-desc">Mix of chalk and upsets</span>
            </button>
            <button class="ob-option" type="button" data-key="style" data-value="chaos" onclick="selectOption(this)">
              <span class="ob-emoji">C</span>
              <span class="ob-label">High variance</span>
              <span class="ob-desc">Contrarian approach</span>
            </button>
          </div>
        </div>

        <div class="ob-step" data-step="3">
          <div class="ob-question">Which scoring system do you use?</div>
          <div class="ob-hint">Scoring weights change the value of upsets.</div>
          <div class="ob-options">
            <button class="ob-option" type="button" data-key="scoring" data-value="espn" onclick="selectOption(this)">
              <span class="ob-emoji">E</span>
              <span class="ob-label">ESPN standard</span>
              <span class="ob-desc">10-20-40-80-160-320</span>
            </button>
            <button class="ob-option" type="button" data-key="scoring" data-value="yahoo" onclick="selectOption(this)">
              <span class="ob-emoji">Y</span>
              <span class="ob-label">Yahoo doubling</span>
              <span class="ob-desc">1-2-4-8-16-32</span>
            </button>
            <button class="ob-option" type="button" data-key="scoring" data-value="upset_bonus" onclick="selectOption(this)">
              <span class="ob-emoji">U</span>
              <span class="ob-label">Upset bonus</span>
              <span class="ob-desc">Extra points for upsets</span>
            </button>
          </div>
        </div>

        <div class="ob-nav">
          <div class="ob-dots">
            <span class="ob-dot active"></span>
            <span class="ob-dot"></span>
            <span class="ob-dot"></span>
          </div>
          <button class="ob-skip" type="button" onclick="skipOnboarding()">Skip</button>
        </div>
      </div>
    </div>

    <div class="hdr">
      <div class="logo">BG</div>
      <div class="title-wrap">
        <h1 id="an">BracketGPT</h1>
        <div class="sub" id="at">Data-Driven Tournament Assistant</div>
      </div>
      <span class="live" id="live-tag">Model online</span>
    </div>

    <div class="msgs" id="msgs">
      <div class="hero" id="wel">
        <div>
          <div class="kicker">NCAA Analytics Workspace</div>
          <h2 id="hero-brand">BracketGPT</h2>
          <div class="tagline" id="hero-tagline">Sharper picks, cleaner process, better pool outcomes.</div>
          <p>Use matchup projections, upset probability, and bracket strategy in one chat-first workspace.</p>

          <div class="cta">
            <button class="cta-btn primary" onclick="go('Build my bracket strategy for this season')">Build My Strategy</button>
            <button class="cta-btn" onclick="go('Analyze a matchup: Duke vs Houston')">Analyze Matchup</button>
            <button class="cta-btn" onclick="window.location.href='/value-picks'">Value Picks</button>
          </div>

          <div class="quick">
            <button onclick="go('Best upset candidates in round one?')">Round 1 upset candidates</button>
            <button onclick="go('Which 12-seeds profile best this year?')">Top 12-seed profiles</button>
            <button onclick="go('Compare the top 1-seeds')">Compare top 1-seeds</button>
            <button onclick="go('Give me a contrarian Final Four for a large pool')">Contrarian Final Four</button>
            <button onclick="go('What are the safest chalk picks?')">Safest chalk picks</button>
            <button onclick="go('How should I optimize for a 50-person pool?')">50-person pool plan</button>
          </div>

          <div class="hypo">
            <input id="hypo-a" type="text" placeholder="Team A (e.g., Florida)" />
            <span class="vs-text">VS</span>
            <input id="hypo-b" type="text" placeholder="Team B (e.g., Auburn)" />
            <button class="cta-btn primary" onclick="runHypo()">Run Matchup</button>
          </div>
        </div>
      </div>

      <div class="typing" id="typ">
        <div class="av">BG</div>
        <div class="dots"><span></span><span></span><span></span></div>
      </div>
    </div>

    <div class="iw">
      <div class="ir">
        <input type="text" id="inp" placeholder="Ask about any team, matchup, or strategy..." autocomplete="off" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();go()}" />
        <button class="snd" id="btn" onclick="go()" aria-label="Send prompt">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13" />
            <polygon points="22 2 15 22 11 13 2 9 22 2" />
          </svg>
        </button>
      </div>
      <div class="hint">Model ensemble and matchup projections</div>
    </div>
  </div>

  <script>
    const $ = (s) => document.getElementById(s);
    const msgs = $('msgs');
    const inp = $('inp');
    const btn = $('btn');
    const typ = $('typ');
    let hist = [];
    let busy = false;
    let onboardingAnswers = {};
    let currentStep = 1;

    (async () => {
      try {
        const r = await fetch('/api/config');
        if (r.ok) {
          const c = await r.json();
          if (c.brandName) {
            $('an').textContent = c.brandName;
            $('hero-brand').textContent = c.brandName;
            document.title = c.brandName;
          }
          if (c.tagline) {
            $('at').textContent = c.tagline;
            $('hero-tagline').textContent = c.tagline;
          }
          if (c.activeSeason) $('live-tag').textContent = `Season ${c.activeSeason}`;
        }
      } catch (e) {}
    })();

    inp.addEventListener('input', () => btn.classList.toggle('on', inp.value.trim().length > 0));

    (function prefillFromQuery() {
      const q = new URLSearchParams(window.location.search).get('q');
      if (!q) return;
      inp.value = q;
      btn.classList.add('on');
      setTimeout(() => go(q), 0);
    })();

    (function initOnboarding() {
      const saved = sessionStorage.getItem('bracketgpt_profile');
      if (!saved) return;
      try {
        onboardingAnswers = JSON.parse(saved) || {};
      } catch (e) {
        onboardingAnswers = {};
      }
      const overlay = $('onboarding');
      if (overlay) overlay.classList.add('hidden');
    })();

    function selectOption(btnEl) {
      const key = btnEl.dataset.key;
      const value = btnEl.dataset.value;
      onboardingAnswers[key] = value;

      const wrap = btnEl.closest('.ob-options');
      if (wrap) wrap.querySelectorAll('.ob-option').forEach((b) => b.classList.remove('selected'));
      btnEl.classList.add('selected');

      setTimeout(() => {
        if (currentStep < 3) {
          currentStep += 1;
          showStep(currentStep);
        } else {
          finishOnboarding();
        }
      }, 220);
    }

    function showStep(step) {
      document.querySelectorAll('.ob-step').forEach((s) => s.classList.remove('active'));
      const target = document.querySelector(`.ob-step[data-step="${step}"]`);
      if (target) target.classList.add('active');
      document.querySelectorAll('.ob-dot').forEach((d, i) => d.classList.toggle('active', i < step));
    }

    function skipOnboarding() {
      onboardingAnswers = { poolSize: 'medium', style: 'balanced', scoring: 'espn' };
      finishOnboarding();
    }

    function finishOnboarding() {
      sessionStorage.setItem('bracketgpt_profile', JSON.stringify(onboardingAnswers));
      const overlay = $('onboarding');
      if (overlay) overlay.classList.add('hidden');
    }

    function getPoolContext() {
      const p = onboardingAnswers || {};
      if (!p.poolSize) return '';
      const poolMap = { small: '~10-25 person', medium: '~50-100 person', large: '100+ person' };
      const styleMap = { chalk: 'safe/chalk', balanced: 'balanced', chaos: 'upset-heavy/contrarian' };
      const scoringMap = { espn: 'ESPN 10-20-40-80-160-320', yahoo: 'Yahoo 1-2-4-8-16-32', upset_bonus: 'upset bonus scoring' };
      return `[POOL CONTEXT: ${poolMap[p.poolSize] || 'medium'} pool, ${styleMap[p.style] || 'balanced'} style, ${scoringMap[p.scoring] || 'ESPN'} scoring] `;
    }

    function scroll() { msgs.scrollTop = msgs.scrollHeight; }

    function esc(t) {
      const d = document.createElement('div');
      d.textContent = t;
      return d.innerHTML;
    }

    function parseMatchupCard(text) {
      const scoreMatch = text.match(/(?:projected\s+score|score)\s*[:\-]\s*([A-Za-z .'-]+)\s*(\d{2,3})\s*[,\-]\s*([A-Za-z .'-]+)\s*(\d{2,3})/i);
      const winMatch = text.match(/win\s+prob(?:ability)?\s*[:\-]\s*([A-Za-z .'-]+)?\s*(\d{1,3})%/i);
      const upsetMatch = text.match(/upset\s+prob(?:ability)?\s*[:\-]\s*(\d{1,3})%/i);
      if (!scoreMatch || !winMatch) return '';

      const teamA = scoreMatch[1].trim();
      const scoreA = Number(scoreMatch[2]);
      const teamB = scoreMatch[3].trim();
      const scoreB = Number(scoreMatch[4]);
      const winner = scoreA >= scoreB ? teamA : teamB;
      const winPct = Math.max(0, Math.min(100, Number(winMatch[2])));
      const upsetPct = upsetMatch ? Number(upsetMatch[1]) : 0;

      return `<div class="scoreboard">
        <div class="teams">
          <div class="team ${winner === teamA ? 'winner' : ''}">
            <div class="name">${esc(teamA)}</div>
            <div class="score" data-score="${scoreA}">0</div>
          </div>
          <div class="vs">VS</div>
          <div class="team ${winner === teamB ? 'winner' : ''}">
            <div class="name">${esc(teamB)}</div>
            <div class="score" data-score="${scoreB}">0</div>
          </div>
        </div>
        <div class="metrics">
          <div class="bar-head"><span>${esc(winner)} win probability</span><span>${winPct}%</span></div>
          <div class="bar-track"><div class="bar-fill" data-width="${winPct}"></div></div>
          ${upsetPct > 30 ? `<div class="upset">Upset risk ${upsetPct}%</div>` : ''}
        </div>
      </div>`;
    }

    function fmt(t) {
      const card = parseMatchupCard(t);
      let s = t
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/`([^`]+)`/g, '<code>$1</code>');

      const blocks = s.split(/\n{2,}/);
      let h = card;
      for (const b of blocks) {
        const tr = b.trim();
        if (!tr) continue;
        const lines = tr.split('\n');
        const isList = lines.length > 1 && lines.filter((l) => l.trim()).every((l) => /^\s*[-*]\s|^\s*\d+[.)]\s/.test(l));
        if (isList) {
          h += '<ul style="margin:8px 0 8px 18px">' + lines.filter((l) => l.trim()).map((l) => `<li>${l.replace(/^\s*[-*]\s*/, '').replace(/^\s*\d+[.)]\s*/, '')}</li>`).join('') + '</ul>';
        } else {
          h += `<p style="margin:0 0 8px">${tr.replace(/\n/g, '<br>')}</p>`;
        }
      }
      return h || `<p>${s}</p>`;
    }

    function animateMessage(el) {
      el.querySelectorAll('.bar-fill').forEach((bar) => {
        requestAnimationFrame(() => { bar.style.width = `${bar.dataset.width}%`; });
      });
      el.querySelectorAll('.score[data-score]').forEach((scoreEl) => {
        const target = Number(scoreEl.dataset.score);
        const start = performance.now();
        const duration = 900;
        const tick = (now) => {
          const p = Math.min(1, (now - start) / duration);
          scoreEl.textContent = Math.round(target * p);
          if (p < 1) requestAnimationFrame(tick);
        };
        requestAnimationFrame(tick);
      });
    }

    function add(w, t) {
      const e = $('wel');
      if (e) e.remove();
      const d = document.createElement('div');
      d.className = `m ${w === 'u' ? 'u' : 'b'}`;
      d.innerHTML = `<div class="av">${w === 'u' ? 'YOU' : 'BG'}</div><div class="bd">${w === 'u' ? esc(t) : fmt(t)}</div>`;
      msgs.insertBefore(d, typ);
      animateMessage(d);
      scroll();
      return d;
    }

    function runHypo() {
      const a = document.getElementById('hypo-a')?.value?.trim();
      const b = document.getElementById('hypo-b')?.value?.trim();
      if (!a || !b) return;
      go(`Who would win if ${a} played ${b}?`);
    }

    async function go(text) {
      const msg = text || inp.value.trim();
      if (!msg || busy) return;
      inp.value = '';
      btn.classList.remove('on');
      busy = true;
      hist.push({ role: 'user', content: `${getPoolContext()}${msg}` });
      add('u', msg);
      typ.classList.add('on');
      scroll();

      try {
        const r = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messages: hist })
        });
        const d = await r.json();
        typ.classList.remove('on');
        const reply = d.reply || d.error || 'Something went wrong.';
        hist.push({ role: 'assistant', content: reply });
        add('b', reply);
      } catch (e) {
        typ.classList.remove('on');
        add('b', 'Lost connection. Try again.');
      }
      busy = false;
      inp.focus();
    }
  </script>
</body>
</html>
